<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Animation Recorder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Use the original map styles -->
    <link rel="stylesheet" href="css/map-styles.css" />
    <style>
        /* Recorder UI - sits outside the map area */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Poppins', sans-serif;
            background: #2c3e50;
        }
        
        .recorder-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* Top controls bar */
        .recorder-controls {
            background: #34495e;
            padding: 10px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            z-index: 3000;
            border-bottom: 2px solid #2c3e50;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-group label {
            font-size: 12px;
            font-weight: 600;
            color: #bdc3c7;
            text-transform: uppercase;
        }
        
        .control-group select {
            padding: 8px 12px;
            border: none;
            border-radius: 3px;
            background: #2c3e50;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }
        
        .control-group select:focus {
            outline: 2px solid #3498db;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 3px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary { background: #27ae60; color: white; }
        .btn-primary:hover:not(:disabled) { background: #2ecc71; }
        
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover:not(:disabled) { background: #c0392b; }
        
        .btn-info { background: #3498db; color: white; }
        .btn-info:hover:not(:disabled) { background: #2980b9; }
        
        .btn-small { padding: 6px 10px; font-size: 12px; }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .spacer { flex: 1; }
        
        .status-text {
            color: #ecf0f1;
            font-size: 13px;
            padding: 8px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
        }
        
        .status-text.recording {
            background: #e74c3c;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Map wrapper - contains the actual animation area */
        .map-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        /* Override map styles for the recorder context */
        .map-wrapper #map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* Navigation link */
        .nav-link {
            color: #bdc3c7;
            text-decoration: none;
            font-size: 13px;
            padding: 8px 15px;
            border-radius: 3px;
            transition: all 0.2s;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .nav-link.active {
            background: #3498db;
            color: white;
        }
        
        .brand {
            font-weight: 700;
            font-size: 16px;
            color: #ecf0f1;
            margin-right: 20px;
        }
        
        /* Progress overlay */
        .progress-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 4000;
            align-items: center;
            justify-content: center;
        }
        
        .progress-overlay.active {
            display: flex;
        }
        
        .progress-box {
            background: white;
            border-radius: 3px;
            padding: 30px 50px;
            text-align: center;
            max-width: 400px;
        }
        
        .progress-box h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
        }
        
        .progress-bar-container {
            background: #ecf0f1;
            height: 8px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .progress-spinner {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }
        
        .progress-spinner svg {
            width: 100%;
            height: 100%;
        }
        
        .progress-percent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .progress-stages {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .stage {
            font-size: 12px;
            color: #bdc3c7;
            transition: all 0.2s;
        }
        
        .stage.active {
            color: #27ae60;
            font-weight: 600;
        }
        
        /* Download Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-box {
            background: #34495e;
            border-radius: 3px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        
        .modal-box h3 {
            margin: 0 0 5px 0;
            color: #ecf0f1;
            font-size: 22px;
        }
        
        .modal-subtitle {
            color: #95a5a6;
            margin: 0 0 25px 0;
            font-size: 14px;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #7f8c8d;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: #ecf0f1;
        }
        
        .format-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .format-btn {
            flex: 1;
            background: #2c3e50;
            border: 2px solid #4a6278;
            border-radius: 3px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .format-btn:hover {
            border-color: #3498db;
            background: #3d5a73;
        }
        
        .format-btn.selected {
            border-color: #27ae60;
            background: #2c5a42;
        }
        
        .format-icon {
            display: block;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .format-name {
            display: block;
            color: #ecf0f1;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .format-desc {
            display: block;
            color: #7f8c8d;
            font-size: 11px;
        }
        
        .mp4-options {
            background: #2c3e50;
            border-radius: 3px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .option-group {
            margin-bottom: 15px;
        }
        
        .option-group label {
            display: block;
            color: #bdc3c7;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .option-group select {
            width: 100%;
            padding: 10px 12px;
            border: none;
            border-radius: 3px;
            background: #34495e;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .option-group select:focus {
            outline: 2px solid #3498db;
        }
        
        .mp4-options .btn {
            width: 100%;
            margin-top: 10px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="recorder-container">
        <!-- Controls Bar -->
        <div class="recorder-controls">
            <span class="brand">üó∫Ô∏è Map Recorder</span>
            <a href="recorder.html" class="nav-link active">Recorder</a>
            <a href="editor.html" class="nav-link">Editor</a>
            
            <div class="spacer"></div>
            
            <div class="control-group">
                <label>Route:</label>
                <select id="routeSelect">
                    <option value="">Loading...</option>
                </select>
                <button id="reloadBtn" class="btn btn-small">üîÑ</button>
            </div>
            
            <div class="control-group">
                <label>Tiles:</label>
                <select id="tileSelect">
                    <option value="osm">OpenStreetMap</option>
                    <option value="watercolor">Watercolor</option>
                    <option value="terrain">Terrain</option>
                    <option value="toner">Light</option>
                    <option value="dark">Dark</option>
                    <option value="voyager">Voyager</option>
                    <option value="humanitarian">Humanitarian</option>
                </select>
            </div>
            
            <button id="previewBtn" class="btn btn-info">‚ñ∂Ô∏è Preview</button>
            <button id="recordBtn" class="btn btn-primary">üé¨ Record</button>
            <button id="downloadBtn" class="btn btn-success" disabled>üíæ Download</button>
            
            <span id="status" class="status-text">Ready</span>
        </div>
        
        <!-- Map Area - Uses original map.html structure -->
        <div class="map-wrapper" id="mapWrapper">
            <div id="map"></div>
            <div id="parchment-overlay"></div>
            <div id="title-card"></div>
            <div id="destination-card"><div class="destination-text"></div></div>
            <div id="compass">
                <svg viewBox="0 0 200 200">
                    <circle cx="100" cy="100" r="98" fill="none" stroke="#3d2817" stroke-width="2"/>
                    <circle cx="100" cy="100" r="90" fill="#f4e8d0" stroke="#8B4513" stroke-width="3"/>
                    <circle cx="100" cy="100" r="82" fill="none" stroke="#8B4513" stroke-width="1.5" stroke-dasharray="5,3"/>
                    <line x1="100" y1="12" x2="100" y2="30" stroke="#8B0000" stroke-width="4" stroke-linecap="round"/>
                    <line x1="100" y1="170" x2="100" y2="188" stroke="#3d2817" stroke-width="3" stroke-linecap="round"/>
                    <line x1="12" y1="100" x2="30" y2="100" stroke="#3d2817" stroke-width="3" stroke-linecap="round"/>
                    <line x1="170" y1="100" x2="188" y2="100" stroke="#3d2817" stroke-width="3" stroke-linecap="round"/>
                    <line x1="32" y1="32" x2="42" y2="42" stroke="#666" stroke-width="2"/>
                    <line x1="168" y1="32" x2="158" y2="42" stroke="#666" stroke-width="2"/>
                    <line x1="32" y1="168" x2="42" y2="158" stroke="#666" stroke-width="2"/>
                    <line x1="168" y1="168" x2="158" y2="158" stroke="#666" stroke-width="2"/>
                    <text x="100" y="25" text-anchor="middle" font-size="32" font-family="serif" font-weight="bold" fill="#8B0000" stroke="#f4e8d0" stroke-width="0.5">N</text>
                    <text x="100" y="183" text-anchor="middle" font-size="22" font-family="serif" font-weight="bold" fill="#3d2817">S</text>
                    <text x="178" y="107" text-anchor="middle" font-size="22" font-family="serif" font-weight="bold" fill="#3d2817">E</text>
                    <text x="22" y="107" text-anchor="middle" font-size="22" font-family="serif" font-weight="bold" fill="#3d2817">W</text>
                    <text x="150" y="55" text-anchor="middle" font-size="14" font-family="serif" fill="#666">NE</text>
                    <text x="150" y="155" text-anchor="middle" font-size="14" font-family="serif" fill="#666">SE</text>
                    <text x="50" y="155" text-anchor="middle" font-size="14" font-family="serif" fill="#666">SW</text>
                    <text x="50" y="55" text-anchor="middle" font-size="14" font-family="serif" fill="#666">NW</text>
                    <polygon points="100,18 103,35 100,32 97,35" fill="#8B0000" stroke="#3d2817" stroke-width="1"/>
                    <polygon points="100,182 97,165 100,168 103,165" fill="#d4c5a9" stroke="#3d2817" stroke-width="1"/>
                    <circle cx="100" cy="100" r="12" fill="#3d2817" stroke="#8B4513" stroke-width="2"/>
                    <circle cx="100" cy="100" r="6" fill="#f4e8d0"/>
                    <circle cx="100" cy="100" r="3" fill="#8B4513"/>
                </svg>
            </div>
            <div id="date-stamp"></div>
            <!-- Icons use the original PNG files from map-styles.css -->
            <div id="motorcycle" style="display:none;"></div>
            <div id="person" style="display:none;"></div>
            <div id="car" style="display:none;"></div>
            <div id="backpacker" style="display:none;"></div>
        </div>
    </div>
    
    <!-- Download Format Dialog -->
    <div class="modal-overlay" id="downloadModal">
        <div class="modal-box">
            <h3>Download Video</h3>
            <p class="modal-subtitle">Choose your preferred format</p>
            
            <div class="format-options">
                <button class="format-btn" id="downloadWebmBtn">
                    <span class="format-icon">üìπ</span>
                    <span class="format-name">WebM</span>
                    <span class="format-desc">Best quality, instant download</span>
                </button>
                
                <button class="format-btn" id="downloadMp4Btn">
                    <span class="format-icon">üé¨</span>
                    <span class="format-name">MP4</span>
                    <span class="format-desc">Universal compatibility</span>
                </button>
            </div>
            
            <!-- MP4 Quality Settings (hidden by default) -->
            <div class="mp4-options" id="mp4Options" style="display: none;">
                <div class="option-group">
                    <label>Video Quality</label>
                    <select id="mp4Quality">
                        <option value="18">High (Larger file)</option>
                        <option value="23" selected>Medium (Recommended)</option>
                        <option value="28">Low (Smaller file)</option>
                    </select>
                </div>
                <div class="option-group">
                    <label>Video Codec</label>
                    <select id="mp4Codec">
                        <option value="h264" selected>H.264 (Best compatibility)</option>
                        <option value="h265">H.265 (Better compression)</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="confirmMp4Btn">Convert & Download</button>
            </div>
            
            <button class="modal-close" id="closeDownloadModal">‚úï</button>
        </div>
    </div>

    <!-- Progress Overlay -->
    <div class="progress-overlay" id="progressContainer">
        <div class="progress-box">
            <h3 id="progressTitle">Processing...</h3>
            <div class="progress-spinner">
                <svg viewBox="0 0 50 50">
                    <circle cx="25" cy="25" r="20" fill="none" stroke="#ecf0f1" stroke-width="4"/>
                    <circle id="progressSpinnerFill" cx="25" cy="25" r="20" fill="none" stroke="#27ae60" stroke-width="4" stroke-dasharray="126" stroke-dashoffset="126" stroke-linecap="round" transform="rotate(-90 25 25)"/>
                </svg>
                <span id="progressPercent" class="progress-percent">0%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
            <div id="progressLabel" class="progress-text">Preparing...</div>
            <div id="progressSublabel" class="progress-text" style="font-size: 12px; opacity: 0.7;"></div>
            <div class="progress-stages">
                <span id="stageLoad" class="stage">üì• Load</span>
                <span id="stageEncode" class="stage">‚öôÔ∏è Encode</span>
                <span id="stageFinalize" class="stage">‚úÖ Done</span>
            </div>
        </div>
    </div>

    <!-- Alert/Confirm Modal -->
    <div class="modal-overlay" id="alertModal">
        <div class="modal-box">
            <h3 id="alertModalTitle">Notice</h3>
            <p id="alertModalMessage" class="modal-subtitle"></p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="alertModalCancel" style="display: none;">Cancel</button>
                <button class="btn btn-primary" id="alertModalOk">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Load the original animation modules (non-module scripts) -->
    <script src="js/zoom-utils.js"></script>
    <script src="js/animation-core.js"></script>
    <script src="js/map-init.js"></script>
    <script src="js/animate-route.js"></script>
    
    <!-- Recorder module -->
    <script type="module" src="js/recorder.js"></script>
</body>
</html>
