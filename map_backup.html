<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Animation</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Special Elite', 'Courier New', monospace;
            overflow: hidden;
        }
        #map {
            width: 1920px;
            height: 1080px;
            position: relative;
        }
        .leaflet-container {
            background: #e8dcc7;
            /* Vintage map styling */
            filter: sepia(0.4) saturate(0.6) contrast(1.15) brightness(1.05);
        }
        
        /* Make map tiles look aged */
        .leaflet-tile {
            filter: contrast(0.95) brightness(1.1);
            opacity: 0.95 !important;
        }
        
        /* Parchment texture overlay */
        #parchment-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(139, 90, 43, 0.03) 2px, rgba(139, 90, 43, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(139, 90, 43, 0.03) 2px, rgba(139, 90, 43, 0.03) 4px);
            background-color: rgba(244, 232, 208, 0.4);
            pointer-events: none;
            z-index: 1000;
            mix-blend-mode: multiply;
        }
        
        /* Compass rose */
        #compass {
            position: absolute;
            bottom: 80px;
            right: 80px;
            width: 180px;
            height: 180px;
            z-index: 1001;
            opacity: 0.9;
            filter: drop-shadow(4px 4px 8px rgba(0,0,0,0.4));
        }
        
        /* Date stamp */
        #date-stamp {
            position: absolute;
            top: 30px;
            left: 30px;
            font-family: 'Special Elite', 'Courier New', monospace;
            font-size: 24px;
            color: #3d2817;
            background: rgba(244, 232, 208, 0.9);
            padding: 15px 25px;
            border: 3px solid #8B4513;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.3);
            z-index: 1001;
            transform: rotate(-2deg);
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        /* Centered title card */
        #title-card {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Special Elite', 'Courier New', monospace;
            font-size: 48px;
            color: #3d2817;
            background: rgba(244, 232, 208, 0.95);
            padding: 40px 60px;
            border: 4px solid #8B4513;
            box-shadow: 5px 5px 20px rgba(0,0,0,0.5);
            z-index: 2000;
            text-align: center;
            opacity: 0;
            transition: opacity 1s;
        }
        
        /* Location labels */
        .location-label {
            font-family: 'Special Elite', 'Courier New', monospace;
            font-size: 15px;
            color: #3d2817;
            background: rgba(244, 232, 208, 0.95);
            padding: 8px 12px;
            border: 2px solid #8B4513;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            white-space: nowrap;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Motorcycle icon */
        #motorcycle {
            width: 60px;
            height: 60px;
            position: absolute;
            z-index: 999;
            filter: drop-shadow(4px 4px 6px rgba(0,0,0,0.7));
            pointer-events: none;
            background-image: url('bike.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
</head>
<body>
    <div id="map"></div>
    <div id="parchment-overlay"></div>
    <div id="title-card"></div>
    <div id="compass">
        <svg viewBox="0 0 200 200">
            <!-- Decorative outer circles -->
            <circle cx="100" cy="100" r="98" fill="none" stroke="#3d2817" stroke-width="2"/>
            <circle cx="100" cy="100" r="90" fill="#f4e8d0" stroke="#8B4513" stroke-width="3"/>
            <circle cx="100" cy="100" r="82" fill="none" stroke="#8B4513" stroke-width="1.5" stroke-dasharray="5,3"/>
            
            <!-- Cardinal direction markers -->
            <line x1="100" y1="12" x2="100" y2="30" stroke="#8B0000" stroke-width="4" stroke-linecap="round"/>
            <line x1="100" y1="170" x2="100" y2="188" stroke="#3d2817" stroke-width="3" stroke-linecap="round"/>
            <line x1="12" y1="100" x2="30" y2="100" stroke="#3d2817" stroke-width="3" stroke-linecap="round"/>
            <line x1="170" y1="100" x2="188" y2="100" stroke="#3d2817" stroke-width="3" stroke-linecap="round"/>
            
            <!-- Ordinal markers (smaller) -->
            <line x1="32" y1="32" x2="42" y2="42" stroke="#666" stroke-width="2"/>
            <line x1="168" y1="32" x2="158" y2="42" stroke="#666" stroke-width="2"/>
            <line x1="32" y1="168" x2="42" y2="158" stroke="#666" stroke-width="2"/>
            <line x1="168" y1="168" x2="158" y2="158" stroke="#666" stroke-width="2"/>
            
            <!-- Cardinal directions text -->
            <text x="100" y="25" text-anchor="middle" font-size="32" font-family="serif" font-weight="bold" fill="#8B0000" stroke="#f4e8d0" stroke-width="0.5">N</text>
            <text x="100" y="183" text-anchor="middle" font-size="22" font-family="serif" font-weight="bold" fill="#3d2817">S</text>
            <text x="178" y="107" text-anchor="middle" font-size="22" font-family="serif" font-weight="bold" fill="#3d2817">E</text>
            <text x="22" y="107" text-anchor="middle" font-size="22" font-family="serif" font-weight="bold" fill="#3d2817">W</text>
            
            <!-- Ordinal directions text -->
            <text x="150" y="55" text-anchor="middle" font-size="14" font-family="serif" fill="#666">NE</text>
            <text x="150" y="155" text-anchor="middle" font-size="14" font-family="serif" fill="#666">SE</text>
            <text x="50" y="155" text-anchor="middle" font-size="14" font-family="serif" fill="#666">SW</text>
            <text x="50" y="55" text-anchor="middle" font-size="14" font-family="serif" fill="#666">NW</text>
            
            <!-- Decorative star/compass points -->
            <polygon points="100,18 103,35 100,32 97,35" fill="#8B0000" stroke="#3d2817" stroke-width="1"/>
            <polygon points="100,182 97,165 100,168 103,165" fill="#d4c5a9" stroke="#3d2817" stroke-width="1"/>
            
            <!-- Center ornament -->
            <circle cx="100" cy="100" r="12" fill="#3d2817" stroke="#8B4513" stroke-width="2"/>
            <circle cx="100" cy="100" r="6" fill="#f4e8d0"/>
            <circle cx="100" cy="100" r="3" fill="#8B4513"/>
        </svg>
    </div>
    <div id="date-stamp"></div>
    <div id="motorcycle" style="display:none;"></div>
    
    <script>
        // Initialize map
        let map;
        let animatedLine;
        let startMarker, endMarker;
        
        function initMap(coordinates, options = {}) {
            const {
                zoom = 4,
                lineColor = '#8B4513',
                lineWidth = 3,
                animationDuration = 5000,
                useSmoothing = true
            } = options;
            
            // Calculate center point
            const centerLat = (coordinates[0][0] + coordinates[coordinates.length - 1][0]) / 2;
            const centerLng = (coordinates[0][1] + coordinates[coordinates.length - 1][1]) / 2;
            
            // Create map
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                zoomAnimation: true,
                fadeAnimation: true
            }).setView([centerLat, centerLng], zoom);
            
            // Add reliable OpenStreetMap tile layer (we'll style it vintage with CSS)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            
            // Fit bounds to show entire route
            const bounds = L.latLngBounds(coordinates.map(c => [c[0], c[1]]));
            map.fitBounds(bounds, { padding: [100, 100] });
            
            // Store for animation
            window.mapData = {
                coordinates,
                lineColor,
                lineWidth,
                animationDuration,
                useSmoothing
            };
        }
        
        function animateRoute() {
            return new Promise(async (resolve) => {
                const { coordinates, lineColor, lineWidth, animationDuration, useSmoothing } = window.mapData;
                
                // STAGE 1: Show title card
                const today = new Date();
                const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const titleCard = document.getElementById('title-card');
                titleCard.textContent = dateStr.toUpperCase();
                titleCard.style.opacity = '1';
                
                await new Promise(resolve => setTimeout(resolve, 2500));
                
                // Fade out title card
                titleCard.style.opacity = '0';
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Show date stamp in corner
                const dateStamp = document.getElementById('date-stamp');
                dateStamp.textContent = dateStr.toUpperCase();
                dateStamp.style.opacity = '1';
                
                // STAGE 2: Start zoomed in at starting point
                map.setView(coordinates[0], 14, { animate: false });
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Add start marker
                startMarker = L.circleMarker(coordinates[0], {
                    radius: 10,
                    fillColor: '#8B0000',
                    color: '#3d2817',
                    weight: 3,
                    fillOpacity: 0.9
                }).addTo(map);
                
                // Add start label
                const startLabel = L.marker(coordinates[0], {
                    icon: L.divIcon({
                        className: 'location-label',
                        html: 'START: STANNUM',
                        iconSize: [160, 30],
                        iconAnchor: [80, -20]
                    })
                }).addTo(map);
                
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Add end marker (hidden)
                endMarker = L.circleMarker(coordinates[coordinates.length - 1], {
                    radius: 10,
                    fillColor: '#006400',
                    color: '#3d2817',
                    weight: 3,
                    fillOpacity: 0
                }).addTo(map);
                
                // Add end label (initially hidden)
                const endLabel = L.marker(coordinates[coordinates.length - 1], {
                    icon: L.divIcon({
                        className: 'location-label',
                        html: 'DESTINATION: BERGUM',
                        iconSize: [220, 30],
                        iconAnchor: [110, -20]
                    }),
                    opacity: 0
                }).addTo(map);
                
                window.endLabel = endLabel;
                
                // Show motorcycle
                const motorcycle = document.getElementById('motorcycle');
                motorcycle.style.display = 'block';
                
                // STAGE 3: Animate route WITH simultaneous zoom
                // Calculate zoom levels for smooth transition
                const bounds = L.latLngBounds(coordinates);
                const startZoom = 14;
                const midZoom = map.getBoundsZoom(bounds, false, [100, 100]);
                const endZoom = 14;
                
                const startTime = performance.now();
                let animatedLine = null;
                let lastAngle = 0;
                let lastUpdateIndex = -5;
                
                function drawFrame(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / animationDuration, 1);
                    
                    // Ease-in-out for smoother animation
                    const eased = useSmoothing 
                        ? progress < 0.5 
                            ? 2 * progress * progress 
                            : 1 - Math.pow(-2 * progress + 2, 2) / 2
                        : progress;
                    
                    // Calculate dynamic zoom based on progress
                    let currentZoom;
                    if (progress < 0.15) {
                        // Zoom out phase (first 15% of animation)
                        const zoomProgress = progress / 0.15;
                        currentZoom = startZoom + (midZoom - startZoom) * zoomProgress;
                    } else if (progress > 0.85) {
                        // Zoom in phase (last 15% of animation)
                        const zoomProgress = (progress - 0.85) / 0.15;
                        currentZoom = midZoom + (endZoom - midZoom) * zoomProgress;
                    } else {
                        // Stay at mid zoom
                        currentZoom = midZoom;
                    }
                    
                    // Calculate camera center based on progress
                    const totalPoints = coordinates.length - 1;
                    const currentFloat = eased * totalPoints;
                    const currentIndex = Math.floor(currentFloat);
                    const fraction = currentFloat - currentIndex;
                    
                    // Get current position on route
                    let cameraCenter;
                    if (currentIndex < totalPoints && fraction > 0) {
                        const current = coordinates[currentIndex];
                        const next = coordinates[currentIndex + 1];
                        cameraCenter = [
                            current[0] + (next[0] - current[0]) * fraction,
                            current[1] + (next[1] - current[1]) * fraction
                        ];
                    } else {
                        cameraCenter = coordinates[Math.min(currentIndex, totalPoints)];
                    }
                    
                    // Smoothly pan and zoom camera
                    map.setView(cameraCenter, currentZoom, { animate: false });
                    
                    // Get visible coordinates for line drawing
                    const visibleCoords = coordinates.slice(0, currentIndex + 1);
                    if (currentIndex < totalPoints && fraction > 0) {
                        visibleCoords.push([
                            coordinates[currentIndex][0] + (coordinates[currentIndex + 1][0] - coordinates[currentIndex][0]) * fraction,
                            coordinates[currentIndex][1] + (coordinates[currentIndex + 1][1] - coordinates[currentIndex][1]) * fraction
                        ]);
                    }
                    
                    // Remove old line
                    if (animatedLine) {
                        map.removeLayer(animatedLine);
                    }
                    
                    // Draw new line (dashed for vintage look)
                    if (visibleCoords.length > 1) {
                        animatedLine = L.polyline(visibleCoords, {
                            color: lineColor,
                            weight: lineWidth,
                            opacity: 0.9,
                            smoothFactor: 1,
                            dashArray: '10, 8'
                        }).addTo(map);
                    }
                    
                    // Update motorcycle position with smooth rotation
                    if (visibleCoords.length > 1) {
                        const currentPos = visibleCoords[visibleCoords.length - 1];
                        const point = map.latLngToContainerPoint(currentPos);
                        
                        // Center the motorcycle on the point (25px offset for 50x50 size)
                        motorcycle.style.left = (point.x - 25) + 'px';
                        motorcycle.style.top = (point.y - 25) + 'px';
                        
                        // Only update rotation if we've moved enough points
                        const currentVisibleIndex = visibleCoords.length - 1;
                        if (currentVisibleIndex - lastUpdateIndex >= 3 && visibleCoords.length > 5) {
                            // Use points further apart for more stable rotation
                            const lookbackDistance = Math.min(10, Math.floor(visibleCoords.length / 3));
                            const oldPos = visibleCoords[Math.max(0, visibleCoords.length - lookbackDistance)];
                            const oldPoint = map.latLngToContainerPoint(oldPos);
                            
                            const dx = point.x - oldPoint.x;
                            const dy = point.y - oldPoint.y;
                            
                            // Only update if movement is significant
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            if (distance > 10) {
                                let targetAngle = Math.atan2(dx, -dy) * 180 / Math.PI;
                                
                                // Smooth angle transition (damping)
                                let angleDiff = targetAngle - lastAngle;
                                // Normalize angle difference to -180 to 180
                                while (angleDiff > 180) angleDiff -= 360;
                                while (angleDiff < -180) angleDiff += 360;
                                
                                lastAngle = lastAngle + angleDiff * 0.2; // 20% of the difference for smoother rotation
                                
                                motorcycle.style.transform = `rotate(${lastAngle}deg)`;
                                motorcycle.style.transformOrigin = '25px 25px';
                                
                                lastUpdateIndex = currentVisibleIndex;
                            }
                        } else if (visibleCoords.length <= 5 && currentVisibleIndex === 1) {
                            // Initialize rotation at start
                            const prevPos = visibleCoords[0];
                            const prevPoint = map.latLngToContainerPoint(prevPos);
                            const dx = point.x - prevPoint.x;
                            const dy = point.y - prevPoint.y;
                            lastAngle = Math.atan2(dx, -dy) * 180 / Math.PI;
                            motorcycle.style.transform = `rotate(${lastAngle}deg)`;
                            motorcycle.style.transformOrigin = '25px 25px';
                        }
                    }
                    
                    // Show end marker when complete
                    if (progress >= 0.98) {
                        endMarker.setStyle({ fillOpacity: 0.9 });
                    }
                    
                    if (progress < 1) {
                        requestAnimationFrame(drawFrame);
                    } else {
                        // Show destination label with animation after arrival
                        endMarker.setStyle({ fillOpacity: 0.9 });
                        setTimeout(() => {
                            if (window.endLabel) {
                                window.endLabel.setOpacity(1);
                            }
                            setTimeout(() => resolve(), 1000);
                        }, 500);
                    }
                }
                
                requestAnimationFrame(drawFrame);
            });
        }
        
        // Make functions available globally
        window.initMap = initMap;
        window.animateRoute = animateRoute;
    </script>
</body>
</html>
